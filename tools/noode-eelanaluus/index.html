<!doctype html>
<html lang="et">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>N√µude eelanal√º√ºs ‚Äî Solvere Lab</title>
  <link rel="stylesheet" href="/assets/site.css" />

<!-- Privacy-friendly analytics by Plausible -->
<script async src="https://plausible.io/js/pa-pjc0qZXxUiq_r44m96Ana.js"></script>
<script>
  window.plausible = window.plausible || function () {
    (plausible.q = plausible.q || []).push(arguments);
  };
  plausible.init();
</script>

<!-- Language switcher logic (ET / RU) -->
<script>
(() => {
  const isRU = location.pathname.startsWith("/ru/");
  const current = isRU ? "ru" : "et";

  document.querySelectorAll('.langswitch a[data-lang]').forEach(a => {
    if (a.dataset.lang === current) {
      a.classList.add("active");
    }
  });
})();
</script>
</head>

<body class="page-tool">
<main class="container" id="app">
  
<nav class="tool-nav langswitch" aria-label="Sekundaarne navigatsioon">
  <a href="/" class="tool-nav__link">‚Üê Avaleht</a>
  <span class="tool-nav__sep">¬∑</span>
  <a href="/metoodika/" class="tool-nav__link">Metoodika</a>

  <span class="tool-nav__sep">¬∑</span>

  <a href="/" class="tool-nav__link" data-lang="et">ET</a>
  <span class="tool-nav__sep">¬∑</span>
  <a href="/ru/" class="tool-nav__link" data-lang="ru">RU</a>
</nav>
  
  <!-- HEADER / INTRO -->
  <header class="pagehead">
    <h1>N√µude eelanal√º√ºs</h1>
    <p class="lead">
      Struktureeritud eelanal√º√ºs enne kohtusse p√∂√∂rdumist: n√µude alus, riskid ja t√µendite piisavus.
    </p>

    <div class="notice notice--neutral" role="note" aria-label="Oluline m√§rkus">
      Tegemist on informatiivse eelanal√º√ºsi t√∂√∂riistaga. See ei asenda individuaalset √µigusn√µustamist ega prognoosi menetluse tulemust.
      Vastused salvestuvad √ºksnes Teie brauseris ega edastata serverisse.
    </div>

   <div class="actions">
  <button type="button" class="btn btn-primary" id="btnStart">Alusta anal√º√ºsi</button>
</div>
  </header>

  <!-- PROGRESS -->
  <section class="progresswrap" aria-label="Edenemine">
    <div class="progressbar" role="progressbar" aria-valuemin="0" aria-valuemax="6" aria-valuenow="0">
      <div class="progressbar__fill" id="progressFill" style="width:0%"></div>
    </div>
    <div class="progressmeta">
      <span id="progressLabel">Samm 0 / 6</span>
    </div>
  </section>

  <!-- STEPS (single page, step-by-step) -->
  <section class="steps" id="steps" aria-label="K√ºsimustik" hidden>

    <!-- STEP 1 -->
    <article class="step" data-step="1" aria-labelledby="s1-title" hidden>
      <header class="step__head">
        <h2 id="s1-title">1. N√µude alus</h2>

        <button type="button" class="infoToggle" data-info="s1-info" aria-expanded="false" aria-controls="s1-info">
          (i)
        </button>
      </header>

      <div class="step__info" id="s1-info" hidden>
        Kohustus t√§hendab teise poole lubadust v√µi lepingulist v√µi seadusest tulenevat kohustust midagi teha, mitte teha v√µi h√ºvitada kahju.
        Kui kohustuse sisu ei ole selge, v√µib n√µue olla n√µrgem.
      </div>

      <fieldset class="q" aria-label="N√µude alus k√ºsimus">
        <legend class="q__legend">Kas teisel poolel oli konkreetne kohustus, mille t√§itmist Te n√µuate?</legend>

        <label class="opt">
          <input type="radio" name="basis" value="3" />
          <span>Jah, kohustus on kirjalikult fikseeritud</span>
        </label>

        <label class="opt">
          <input type="radio" name="basis" value="2" />
          <span>Jah, kohustus lepiti kokku suuliselt</span>
        </label>

        <label class="opt">
          <input type="radio" name="basis" value="1" />
          <span>Kohustuse sisu on ebaselge</span>
        </label>

        <label class="opt">
          <input type="radio" name="basis" value="0" />
          <span>Selgelt tuvastatavat kohustust ei ole</span>
        </label>
      </fieldset>

      <footer class="step__nav">
        <button type="button" class="btn" data-action="back" disabled>Tagasi</button>
        <button type="button" class="btn btn-primary" data-action="next">J√§rgmine</button>
      </footer>
    </article>

    <!-- STEP 2 -->
    <article class="step" data-step="2" aria-labelledby="s2-title" hidden>
      <header class="step__head">
        <h2 id="s2-title">2. Kohustuse rikkumine</h2>

        <button type="button" class="infoToggle" data-info="s2-info" aria-expanded="false" aria-controls="s2-info">
          (i)
        </button>
      </header>

      <div class="step__info" id="s2-info" hidden>
        Rikkumine t√§hendab, et kohustust ei t√§idetud, t√§ideti puudulikult v√µi hilinemisega.
        Rikkumine peab olema kirjeldatav ja seostatav konkreetse kohustusega.
      </div>

      <fieldset class="q" aria-label="Rikkumise k√ºsimus">
        <legend class="q__legend">Kas kohustust rikuti ning kas rikkumine on kirjeldatav?</legend>

        <label class="opt">
          <input type="radio" name="breach" value="3" />
          <span>Rikkumine on selgelt tuvastatav ja dokumenteeritud</span>
        </label>

        <label class="opt">
          <input type="radio" name="breach" value="2" />
          <span>Rikkumine on t√µen√§oline, kuid mitte t√§ielikult dokumenteeritud</span>
        </label>

        <label class="opt">
          <input type="radio" name="breach" value="1" />
          <span>Rikkumine on vaieldav</span>
        </label>

        <label class="opt">
          <input type="radio" name="breach" value="0" />
          <span>Rikkumise olemasolu ei ole kindel</span>
        </label>
      </fieldset>

      <footer class="step__nav">
        <button type="button" class="btn" data-action="back">Tagasi</button>
        <button type="button" class="btn btn-primary" data-action="next">J√§rgmine</button>
      </footer>
    </article>

    <!-- STEP 3 -->
    <article class="step" data-step="3" aria-labelledby="s3-title" hidden>
      <header class="step__head">
        <h2 id="s3-title">3. Kahju v√µi n√µude suurus</h2>

        <button type="button" class="infoToggle" data-info="s3-info" aria-expanded="false" aria-controls="s3-info">
          (i)
        </button>
      </header>

      <div class="step__info" id="s3-info" hidden>
        Kahju peab olema rahaliselt m√§√§ratletav.
        N√µude suurus peaks olema arvutatav ja p√µhjendatav, mitte hinnanguline oletus.
      </div>

      <fieldset class="q" aria-label="Kahju k√ºsimus">
        <legend class="q__legend">Kas n√µude suurus on rahaliselt m√§√§ratletud ja p√µhjendatav?</legend>

        <label class="opt">
          <input type="radio" name="damage" value="3" />
          <span>Summa on t√§pselt arvutatav ja p√µhjendatud</span>
        </label>

        <label class="opt">
          <input type="radio" name="damage" value="2" />
          <span>Summa on ligikaudu arvutatav</span>
        </label>

        <label class="opt">
          <input type="radio" name="damage" value="1" />
          <span>Summa on ebam√§√§rane</span>
        </label>

        <label class="opt">
          <input type="radio" name="damage" value="0" />
          <span>Summa ei ole rahaliselt m√§√§ratletud</span>
        </label>
      </fieldset>

      <footer class="step__nav">
        <button type="button" class="btn" data-action="back">Tagasi</button>
        <button type="button" class="btn btn-primary" data-action="next">J√§rgmine</button>
      </footer>
    </article>

    <!-- STEP 4 (weighted x2) -->
    <article class="step step--weighted" data-step="4" aria-labelledby="s4-title" hidden>
      <header class="step__head">
        <h2 id="s4-title">4. T√µendite olemasolu</h2>

        <button type="button" class="infoToggle" data-info="s4-info" aria-expanded="false" aria-controls="s4-info">
          (i)
        </button>
      </header>

      <div class="step__info" id="s4-info" hidden>
        T√µendid v√µivad olla kirjalikud dokumendid, kirjavahetus, arved, lepingud v√µi muud objektiivsed andmed.
        Kohtuvaidluses hinnatakse eelk√µige t√µendite olemasolu ja usaldusv√§√§rsust.
      </div>

      <fieldset class="q" aria-label="T√µendite k√ºsimus">
        <legend class="q__legend">Millised t√µendid kinnitavad Teie v√§idet?</legend>

        <label class="opt">
          <input type="radio" name="evidence" value="3" />
          <span>Mitmed kirjalikud v√µi objektiivsed t√µendid</span>
        </label>

        <label class="opt">
          <input type="radio" name="evidence" value="2" />
          <span>M√µned kirjalikud v√µi muud t√µendid</span>
        </label>

        <label class="opt">
          <input type="radio" name="evidence" value="1" />
          <span>Piiratud v√µi kaudsed t√µendid</span>
        </label>

        <label class="opt">
          <input type="radio" name="evidence" value="0" />
          <span>T√µendid puuduvad</span>
        </label>
      </fieldset>

      <footer class="step__nav">
        <button type="button" class="btn" data-action="back">Tagasi</button>
        <button type="button" class="btn btn-primary" data-action="next">J√§rgmine</button>
      </footer>
    </article>

    <!-- STEP 5 -->
    <article class="step" data-step="5" aria-labelledby="s5-title" hidden>
      <header class="step__head">
        <h2 id="s5-title">5. V√µimalikud vastuv√§ited</h2>

        <button type="button" class="infoToggle" data-info="s5-info" aria-expanded="false" aria-controls="s5-info">
          (i)
        </button>
      </header>

      <div class="step__info" id="s5-info" hidden>
        Vastuv√§ited on p√µhjendused, millega teine pool v√µib n√µudele vastu vaielda.
        N√§iteks v√µib v√§ita, et kohustust ei olnud, kahju ei tekkinud v√µi n√µue on aegunud.
      </div>

      <fieldset class="q" aria-label="Vastuv√§idete k√ºsimus">
        <legend class="q__legend">Kui t√µen√§oline on, et teine pool suudab esitada tugevaid vastuv√§iteid?</legend>

        <label class="opt">
          <input type="radio" name="defenses" value="3" />
          <span>V√§het√µen√§oline</span>
        </label>

        <label class="opt">
          <input type="radio" name="defenses" value="2" />
          <span>V√µimalik</span>
        </label>

        <label class="opt">
          <input type="radio" name="defenses" value="1" />
          <span>T√µen√§oline</span>
        </label>

        <label class="opt">
          <input type="radio" name="defenses" value="0" />
          <span>V√§ga t√µen√§oline</span>
        </label>
      </fieldset>

      <footer class="step__nav">
        <button type="button" class="btn" data-action="back">Tagasi</button>
        <button type="button" class="btn btn-primary" data-action="next">J√§rgmine</button>
      </footer>
    </article>

    <!-- STEP 6 (weighted x2) -->
    <article class="step step--weighted" data-step="6" aria-labelledby="s6-title" hidden>
      <header class="step__head">
        <h2 id="s6-title">6. Aegumisk√ºsimus</h2>

        <button type="button" class="infoToggle" data-info="s6-info" aria-expanded="false" aria-controls="s6-info">
          (i)
        </button>
      </header>

      <div class="step__info" id="s6-info" hidden>
  Aegumine t√§hendab, et t√§htaja m√∂√∂dumisel v√µib n√µude maksmapanek olla piiratud.
  √úldreeglina on n√µuete aegumist√§htaeg sageli 3 aastat, kuid t√§htaeg s√µltub n√µude liigist ja asjaoludest.
  Kui Sa ei ole kuup√§evades kindel, vali pigem ‚ÄúV√µimalik‚Äù.
</div>

      <fieldset class="q" aria-label="Aegumise k√ºsimus">
        <legend class="q__legend">Kas on v√µimalik, et n√µue on aegunud v√µi aegumas?</legend>

        <label class="opt">
          <input type="radio" name="limitation" value="3" />
          <span>Ei ‚Äî juhtum on hiljutine ja kuup√§evad on selged</span>
        </label>

        <label class="opt">
          <input type="radio" name="limitation" value="2" />
          <span>Ebat√µen√§oline ‚Äî juhtum ei ole vana, kuid k√µik kuup√§evad ei ole t√§iesti selged</span>
        </label>

        <label class="opt">
          <input type="radio" name="limitation" value="1" />
          <span>V√µimalik ‚Äî kuup√§evad on ebaselged v√µi juhtum v√µib olla vanem</span>
        </label>

        <label class="opt">
          <input type="radio" name="limitation" value="0" />
          <span>T√µen√§oline ‚Äî juhtum on vana v√µi on selge aegumisoht</span>
        </label>
      </fieldset>

      <footer class="step__nav">
        <button type="button" class="btn" data-action="back">Tagasi</button>
        <button type="button" class="btn btn-primary" data-action="finish">Vaata tulemust</button>
      </footer>
    </article>

  </section>

<!-- RESULTS -->
<section class="results" id="results" aria-label="Tulemus" hidden>

  <header class="results__head">
    <h2>Tulemus</h2>
    <p class="muted">
      Hinnang p√µhineb kaalutud riskikomponentidel, sealhulgas t√µendite olemasolul ja aegumisk√ºsimusel.
    </p>
  </header>

  <!-- Overall -->
  <div class="card overall" id="overallCard" data-level="unknown">
    <div class="overall__badge" id="overallBadge" aria-label="√úldhinnangu indikaator">‚Äî</div>
    <div class="overall__text">
      <div class="overall__title" id="overallTitle">√úldine riskiprofiil</div>
      <div class="overall__desc" id="overallDesc">
        T√§ida k√ºsimustik, et kuvada hinnang.
      </div>
    </div>
  </div>

  <!-- Grid (2x3) -->
  <div class="grid grid-2x3" id="riskGrid">

    <div class="card metric" id="m-basis" data-level="unknown">
      <div class="metric__head">
        <div class="metric__name">N√µude alus</div>
        <div class="metric__dot"></div>
      </div>
      <div class="metric__label" id="m-basis-label">‚Äî</div>
      <div class="metric__note" id="m-basis-note">‚Äî</div>
    </div>

    <div class="card metric" id="m-breach" data-level="unknown">
      <div class="metric__head">
        <div class="metric__name">Rikkumine</div>
        <div class="metric__dot"></div>
      </div>
      <div class="metric__label" id="m-breach-label">‚Äî</div>
      <div class="metric__note" id="m-breach-note">‚Äî</div>
    </div>

    <div class="card metric" id="m-damage" data-level="unknown">
      <div class="metric__head">
        <div class="metric__name">Kahju</div>
        <div class="metric__dot"></div>
      </div>
      <div class="metric__label" id="m-damage-label">‚Äî</div>
      <div class="metric__note" id="m-damage-note">‚Äî</div>
    </div>

    <div class="card metric" id="m-defenses" data-level="unknown">
      <div class="metric__head">
        <div class="metric__name">Vastuv√§ited</div>
        <div class="metric__dot"></div>
      </div>
      <div class="metric__label" id="m-defenses-label">‚Äî</div>
      <div class="metric__note" id="m-defenses-note">‚Äî</div>
    </div>

    <div class="card metric metric--weighted" id="m-evidence" data-level="unknown">
      <div class="metric__head">
        <div class="metric__name">T√µendid</div>
        <div class="metric__dot"></div>
      </div>
      <div class="metric__label" id="m-evidence-label">‚Äî</div>
      <div class="metric__note" id="m-evidence-note">‚Äî</div>
    </div>

    <div class="card metric metric--weighted" id="m-limitation" data-level="unknown">
      <div class="metric__head">
        <div class="metric__name">Aegumine</div>
        <div class="metric__dot"></div>
      </div>
      <div class="metric__label" id="m-limitation-label">‚Äî</div>
      <div class="metric__note" id="m-limitation-note">‚Äî</div>
    </div>

  </div>

  <!-- Info notice -->
  <div class="notice notice--neutral results__note">
    Tegemist on informatiivse eelanal√º√ºsiga ega asenda √µigusn√µustamist.
  </div>

  <!-- Actions -->
  <div class="actions">
    <button type="button" class="btn" id="btnPlanOpen">
      Ava t√∂√∂plaan
    </button>
    <button type="button" class="btn" id="btnEdit">
      Muuda vastuseid
    </button>
    <button type="button" class="btn secondary" id="btnResetBottom">
      L√§htesta
    </button>
  </div>

  <!-- II FAAS: Action plan -->
  <section class="card" id="actionPlanCard" hidden>

    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
      <h3 style="margin:0;">Soovituslik t√∂√∂plaan</h3>
      <button type="button" class="btn secondary" id="btnPlanClose">
        Sulge
      </button>
    </div>

    <p class="muted">
      Kuvatakse ainult need plokid, kus esines n√µrk v√µi kriitiline riskikoht.
    </p>

    <div class="notice" id="planConditions">
      <strong>Enne edasist sammu</strong>
      <ul class="list" id="planConditionsList"></ul>
    </div>

    <div id="planBlocks" style="margin-top:16px;"></div>

    <p class="muted small" style="margin-top:14px;">
      M√§rkus: k√§esolev t√∂√∂plaan on informatiivne ega kujuta endast √µigusn√µustamist.
    </p>

  </section>

</section>

<footer class="footer">
  <p class="small muted">–†—É—Å—Å–∫–∞—è –≤–µ—Ä—Å–∏—è –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ.</p>
  <p class="small muted">
    ¬© 2026 O√ú Solvere (Solvere Lab). K√µik √µigused kaitstud.
  </p>
</footer>

</main>

<script>
(() => {
  const STORAGE_KEY = "solverelab_claim_precheck_v1";

  // ---- Elements
  const stepsWrap = document.getElementById("steps");
  const steps = Array.from(document.querySelectorAll(".step"));
  const results = document.getElementById("results");

  const btnStart = document.getElementById("btnStart");
  const btnEdit = document.getElementById("btnEdit");
  const btnResetBottom = document.getElementById("btnResetBottom");

  const progressFill = document.getElementById("progressFill");
  const progressLabel = document.getElementById("progressLabel");
  const progressBar = document.querySelector(".progressbar");

  const overallCard = document.getElementById("overallCard");
  const overallBadge = document.getElementById("overallBadge");
  const overallTitle = document.getElementById("overallTitle");
  const overallDesc = document.getElementById("overallDesc");

  // Grid card elements
  const gridIds = {
    basis:    { card: "m-basis",     label: "m-basis-label",     note: "m-basis-note" },
    breach:   { card: "m-breach",    label: "m-breach-label",    note: "m-breach-note" },
    damage:   { card: "m-damage",    label: "m-damage-label",    note: "m-damage-note" },
    defenses: { card: "m-defenses",  label: "m-defenses-label",  note: "m-defenses-note" },
    evidence: { card: "m-evidence",  label: "m-evidence-label",  note: "m-evidence-note" },
    limitation:{card: "m-limitation",label: "m-limitation-label",note: "m-limitation-note" },
  };

  // ---- Model (names match radio groups)
  const FIELDS = ["basis", "breach", "damage", "evidence", "defenses", "limitation"];

  // Weights: evidence & limitation are double-weighted
  const WEIGHTS = {
    basis: 1,
    breach: 1,
    damage: 1,
    defenses: 1,
    evidence: 2,
    limitation: 2,
  };

  // Critical ‚Äúhard constraints‚Äù
  const CRITICAL_FIELDS = ["evidence", "limitation"]; // if 0, cannot be Strong; both 0 => Weak

  // Component labels + 1-line notes (based on score 0-3)
const COMPONENT_TEXT = {
  basis: {
    3: { label: "Tugev", note: "Kohustuse olemasolu on selgelt tuvastatav ja m√§√§ratletav." },
    2: { label: "Piisav", note: "Kohustuse olemasolu on tuvastatav, kuid selle sisu vajab t√§psustamist." },
    1: { label: "N√µrk",  note: "Kohustuse sisu ei ole selgelt m√§√§ratletav v√µi vajab olulist t√§psustamist." },
    0: { label: "Kriitiline", note: "Kohustuse olemasolu ei ole esialgse hinnangu alusel tuvastatav." },
  },

  breach: {
    3: { label: "Tugev", note: "Rikkumine on selgelt kirjeldatav ja seostatav konkreetse kohustusega." },
    2: { label: "Piisav", note: "Rikkumine on t√µen√§oline, kuid vajab selgemat seost kohustusega." },
    1: { label: "N√µrk",  note: "Rikkumise olemasolu v√µi selle seos kohustusega v√µib olla vaieldav." },
    0: { label: "Kriitiline", note: "Rikkumise olemasolu v√µi selle seos kohustusega ei ole piisavalt tuvastatav." },
  },

  damage: {
    3: { label: "Tugev", note: "N√µude suurus on rahaliselt m√§√§ratletud ja p√µhjendatav." },
    2: { label: "Piisav", note: "N√µude suurus on m√§√§ratav, kuid arvutusk√§ik v√µi p√µhjendus vajab t√§iendamist." },
    1: { label: "N√µrk",  note: "N√µude suurus ei ole piisavalt m√§√§ratletud v√µi vajab t√§iendavat p√µhjendust." },
    0: { label: "Kriitiline", note: "N√µude suurus ei ole rahaliselt m√§√§ratletud ega p√µhjendatud." },
  },

  evidence: {
    3: { label: "Tugev", note: "Olemas on mitmed asjakohased ja objektiivsed t√µendid." },
    2: { label: "Piisav", note: "Olemas on asjakohaseid t√µendeid, kuid nende piisavus v√µib olla vaieldav." },
    1: { label: "N√µrk",  note: "T√µendid on piiratud v√µi kaudsed ning nende piisavus v√µib olla k√ºsitav." },
    0: { label: "Kriitiline", note: "Asjakohased t√µendid puuduvad v√µi ei toeta v√§idet piisaval m√§√§ral." },
  },

  defenses: {
    3: { label: "Tugev", note: "Olulised vastuv√§ited ei ole esialgse hinnangu alusel t√µen√§olised." },
    2: { label: "Piisav", note: "V√µimalikud vastuv√§ited v√µivad m√µjutada n√µude hinnangut." },
    1: { label: "N√µrk",  note: "V√µimalikud vastuv√§ited v√µivad oluliselt m√µjutada n√µude hinnangut." },
    0: { label: "Kriitiline", note: "V√µimalikud vastuv√§ited v√µivad oluliselt piirata n√µude eluj√µulisust." },
  },

  limitation: {
    3: { label: "Tugev", note: "Aegumise riski ei ole esialgse hinnangu alusel tuvastatud." },
    2: { label: "Piisav", note: "Aegumise risk ei ole esialgse hinnangu alusel t√µen√§oline, kuid vajab kontrolli." },
    1: { label: "N√µrk",  note: "Aegumise risk v√µib esineda ja vajab t√§iendavat kontrolli." },
    0: { label: "Kriitiline", note: "Aegumise risk v√µib oluliselt piirata n√µude maksmapanekut." },
  },
};

  // Overall labels (no percentages shown)
  const OVERALL_TEXT = {
    strong:   { badge: "üü¢", title: "√úldine riskiprofiil: tugev", desc: "Riskikomponendid on valdavalt piisavad ning kriitilisi piiranguid ei tuvastatud." },
    moderate: { badge: "üü°", title: "√úldine riskiprofiil: m√µ√µdukas", desc: "Esineb n√µrku kohti v√µi ebakindlust. Enne edasist sammu tasub komponentide sisu t√§psustada." },
    weak:     { badge: "üî¥", title: "√úldine riskiprofiil: n√µrk", desc: "Esineb kriitilisi puudusi v√µi mitut olulist riskikohta. N√µude struktuur vajab l√§bim√µtlemist ja t√§iendamist." },
  };

  // ---- State
  let currentStep = 1;

  // ---- Helpers
  function qs(sel, root = document) { return root.querySelector(sel); }
  function qsa(sel, root = document) { return Array.from(root.querySelectorAll(sel)); }

  function getSaved() {
    try {
      const raw = sessionStorage.getItem(STORAGE_KEY);
      return raw ? JSON.parse(raw) : {};
    } catch {
      return {};
    }
  }

  function save(data) {
    sessionStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  }

  function clearSaved() {
    sessionStorage.removeItem(STORAGE_KEY);
  }

  function setProgress(step) {
    const pct = Math.round((step - 1) / 6 * 100);
    progressFill.style.width = pct + "%";
    progressLabel.textContent = `Samm ${step} / 6`;
    progressBar.setAttribute("aria-valuenow", String(step - 1));
  }

  function showStep(n) {
    currentStep = n;

    stepsWrap.hidden = false;
    results.hidden = true;

    steps.forEach(s => s.hidden = (Number(s.dataset.step) !== n));

    setProgress(n);

    stepsWrap.scrollIntoView({ behavior: "smooth", block: "start" });
  }

  function showResults() {
    stepsWrap.hidden = false;
    steps.forEach(s => s.hidden = true);

    results.hidden = false;

    progressFill.style.width = "100%";
    progressLabel.textContent = "Samm 6 / 6";
    progressBar.setAttribute("aria-valuenow", "6");

    results.scrollIntoView({ behavior: "smooth", block: "start" });
  }

  function getSelectedValue(field) {
    const el = qs(`input[name="${field}"]:checked`);
    if (!el) return null;
    const v = Number(el.value);
    return Number.isFinite(v) ? v : null;
  }

  function setSelectedValue(field, value) {
    const el = qs(`input[name="${field}"][value="${value}"]`);
    if (el) el.checked = true;
  }

  function validateStepAnswered(stepNumber) {
    const stepEl = steps.find(s => Number(s.dataset.step) === stepNumber);
    if (!stepEl) return true;

    const radio = qs('input[type="radio"]', stepEl);
    if (!radio) return true;

    const field = radio.name;
    const v = getSelectedValue(field);
    return v !== null;
  }

  function fieldForStep(stepNumber) {
    const stepEl = steps.find(s => Number(s.dataset.step) === stepNumber);
    if (!stepEl) return null;
    const radio = qs('input[type="radio"]', stepEl);
    return radio ? radio.name : null;
  }

  function resumeFromAnswers(saved) {
    // Find first unanswered step
    for (let i = 1; i <= 6; i++) {
      const field = fieldForStep(i);
      if (!field) continue;
      if (saved[field] === undefined || saved[field] === null) return i;
    }
    return 6; // all answered -> last step
  }

  // ---- Scoring
  function computeModel(scores) {
    // Weighted sum
    let weightedSum = 0;
    let maxSum = 0;

    for (const f of FIELDS) {
      const w = WEIGHTS[f] ?? 1;
      const v = scores[f];
      weightedSum += v * w;
      maxSum += 3 * w;
    }

    const ratio = maxSum > 0 ? (weightedSum / maxSum) : 0;

    // Critical constraints
    const crit0 = CRITICAL_FIELDS.filter(f => scores[f] === 0).length;

    // Base band by ratio (not shown to user)
    let band = "moderate";
    if (ratio >= 0.75) band = "strong";
    else if (ratio < 0.5) band = "weak";
    else band = "moderate";

    // Apply constraints
    if (crit0 >= 2) band = "weak";
    else if (crit0 >= 1 && band === "strong") band = "moderate";

    return { band, ratio };
  }

  function levelFromScore(score) {
    // map 0-3 to UI level token
    if (score === 3) return "strong";
    if (score === 2) return "moderate";
    if (score === 1) return "weak";
    return "critical";
  }

  function renderDashboard(scores) {
    // Overall
    const { band } = computeModel(scores);

    const o = OVERALL_TEXT[band];
    overallBadge.textContent = o.badge;
    overallTitle.textContent = o.title;
    overallDesc.textContent = o.desc;

    overallCard.dataset.level = band;

    // Components
    for (const f of FIELDS) {
      const score = scores[f];
      const t = COMPONENT_TEXT[f][score];

      const ids = gridIds[f];
      const card = document.getElementById(ids.card);
      const label = document.getElementById(ids.label);
      const note = document.getElementById(ids.note);

      label.textContent = t.label;
      note.textContent = t.note;

      // dataset level can be styled in CSS
      card.dataset.level = levelFromScore(score);
    }
  }

  // ---- Persistence
  function readAllAnswersFromDOM() {
    const out = {};
    for (const f of FIELDS) {
      const v = getSelectedValue(f);
      if (v !== null) out[f] = v;
    }
    return out;
  }

  function applySavedToDOM(saved) {
    for (const f of FIELDS) {
      const v = saved[f];
      if (v === 0 || v === 1 || v === 2 || v === 3) {
        setSelectedValue(f, v);
      }
    }
  }

  function allAnswered(saved) {
    return FIELDS.every(f => (saved[f] === 0 || saved[f] === 1 || saved[f] === 2 || saved[f] === 3));
  }

  // Save on answer change
  function bindAnswerPersistence() {
    document.addEventListener("change", (e) => {
      const inp = e.target;
      if (!(inp instanceof HTMLInputElement)) return;
      if (inp.type !== "radio") return;

      const field = inp.name;
      if (!FIELDS.includes(field)) return;

      const saved = getSaved();
      saved[field] = Number(inp.value);
      save(saved);
    });
  }

  // ---- UI events
  function resetAll() {
    qsa('input[type="radio"]').forEach(i => (i.checked = false));
    clearSaved();

    progressFill.style.width = "0%";
    progressLabel.textContent = "Samm 0 / 6";
    progressBar.setAttribute("aria-valuenow", "0");

    results.hidden = true;
    stepsWrap.hidden = true;

    // reset cards
    overallCard.dataset.level = "unknown";
    overallBadge.textContent = "‚Äî";
    overallTitle.textContent = "√úldine riskiprofiil";
    overallDesc.textContent = "T√§ida k√ºsimustik, et kuvada hinnang.";

for (const f of FIELDS) {
  const ids = gridIds[f];
  const card = document.getElementById(ids.card);
  document.getElementById(ids.label).textContent = "‚Äî";
  document.getElementById(ids.note).textContent = "‚Äî";
  card.dataset.level = "unknown";
}

// ‚úÖ Reset Start button label
btnStart.textContent = "Alusta anal√º√ºsi";

document.getElementById("app").scrollIntoView({ behavior: "smooth", block: "start" });
}

  function bindNavAndInfo() {
    document.addEventListener("click", (e) => {
      const btn = e.target.closest("button");
      if (!btn) return;

      // Info toggles
      if (btn.classList.contains("infoToggle")) {
        const infoId = btn.getAttribute("data-info");
        const infoEl = document.getElementById(infoId);
        const expanded = btn.getAttribute("aria-expanded") === "true";
        btn.setAttribute("aria-expanded", String(!expanded));
        infoEl.hidden = expanded;
        return;
      }

      const action = btn.getAttribute("data-action");
      if (!action) return;

      if (action === "back") {
        if (currentStep > 1) showStep(currentStep - 1);
        return;
      }

      if (action === "next") {
        if (!validateStepAnswered(currentStep)) {
          alert("Palun vali √ºks vastusevariant, et j√§tkata.");
          return;
        }
        if (currentStep < 6) showStep(currentStep + 1);
        return;
      }

      if (action === "finish") {
        if (!validateStepAnswered(currentStep)) {
          alert("Palun vali √ºks vastusevariant, et kuvada tulemus.");
          return;
        }

        const saved = { ...getSaved(), ...readAllAnswersFromDOM() };
        save(saved);

        if (!allAnswered(saved)) {
          alert("Palun vasta k√µigile plokkidele, et kuvada tulemus.");
          // jump to first unanswered
          const step = resumeFromAnswers(saved);
          showStep(step);
          return;
        }

        renderDashboard(saved);
        showResults();
        return;
      }
    });
  }

// ---- Start / Resume
function hasAnyAnswers(saved){
  if (!saved) return false;
  return FIELDS.some(f => saved[f] === 0 || saved[f] === 1 || saved[f] === 2 || saved[f] === 3);
}

function initFromStorage() {
  const saved = getSaved();

  // Update Start button label based on saved state
  if (hasAnyAnswers(saved)) {
    btnStart.textContent = "J√§tka anal√º√ºsi";
  } else {
    btnStart.textContent = "Alusta anal√º√ºsi";
  }

  if (!saved || Object.keys(saved).length === 0) return;

  applySavedToDOM(saved);

  // Resume to first unanswered step (or step 6 if all answered)
  const step = resumeFromAnswers(saved);
  stepsWrap.hidden = false;
  showStep(step);

  // If previously finished, show results immediately
  if (allAnswered(saved) && saved.__finished === true) {
    renderDashboard(saved);
    showResults();
  }
}

  // Mark finished when results shown
  function markFinished() {
    const saved = getSaved();
    saved.__finished = true;
    save(saved);
  }

  // Hook ‚Äúfinish‚Äù moment to mark finished
  const _showResults = showResults;
  showResults = function() {
    markFinished();
    _showResults();
  };

  // ---- Bind buttons
  btnStart.addEventListener("click", () => showStep(1));
  btnEdit?.addEventListener("click", () => showStep(1));
  btnResetBottom?.addEventListener("click", resetAll);

  bindNavAndInfo();
  bindAnswerPersistence();
  initFromStorage();

    // --- II FAAS: Action plan generator (uses I faasi scores) ---
  const btnPlanOpen = document.getElementById("btnPlanOpen");
  const btnPlanClose = document.getElementById("btnPlanClose");
  const actionPlanCard = document.getElementById("actionPlanCard");
  const planBlocks = document.getElementById("planBlocks");
  const planConditionsList = document.getElementById("planConditionsList");

  function decisionConditionsFromScores(scores){
    const out = [];

    if (scores.limitation <= 1) out.push("Aegumise k√ºsimus vajab kontrolli.");
    if (scores.evidence <= 1) out.push("T√µendibaasi tuleb t√§iendada.");
    if (scores.basis <= 1 || scores.breach <= 1 || scores.damage <= 1){
      const parts = [];
      if (scores.basis <= 1) parts.push("alus");
      if (scores.breach <= 1) parts.push("rikkumine");
      if (scores.damage <= 1) parts.push("kahju");
      out.push(`N√µude sisu vajab t√§psustamist: ${parts.join(", ")}.`);
    }
    if (scores.defenses === 0) out.push("Vastuv√§idete k√§sitlus on vajalik.");

    // max 3
    return out.slice(0, 3);
  }

 const TASKS = {
  basis: {
    title: "N√µude alus",
    items: [
      "Kirjuta √ºhe lausega √ºles: kes pidi midagi tegema, mida t√§pselt pidi tegema ja millal pidi tegema.",
      "Pane kirja, millele see kohustus tugines (nt leping, kokkulepe, kirjavahetus, seadus).",
      "Kirjelda 3‚Äì5 l√ºhilausena, mis oli kohustuse sisu (ilma hinnangute ja oletusteta).",
      "M√µtle, mida Sa tegelikult n√µuad (nt raha, kohustuse t√§itmist, kahju h√ºvitamist).",
    ],
  },

  breach: {
    title: "Rikkumine",
    items: [
      "Kirjelda faktina, mida tehti valesti, hilinemisega v√µi j√§eti tegemata.",
      "Seo rikkumine konkreetse kohustusega (st millist lubadust v√µi kokkulepet ei t√§idetud).",
      "Koosta lihtne kronoloogia: kuup√§ev, mis toimus, millest see selgub (nt e-kiri, arve, s√µnum).",
    ],
  },

  damage: {
    title: "Kahju",
    items: [
      "Pane kirja, millest n√µude summa koosneb.",
      "Kirjuta lahti arvutusk√§ik (nt summa √ó periood, konkreetne arve, kuludokumendid).",
      "Erista: tegelik kahju ning hinnangulised v√µi tulevased kulud.",
      "M√µtle l√§bi, miks just see rikkumine kahju tekitas (st kuidas rikkumine viis rahalise kaotuseni).",
    ],
  },

  evidence: {
    title: "T√µendid",
    items: [
      "Koosta nimekiri olemasolevatest t√µenditest (nt leping, kirjavahetus, arve, akt, foto).",
      "M√§rgi iga t√µendi juurde, millist v√§idet see kinnitab (nt kohustuse olemasolu, rikkumise toimumine, kahju suurus).",
      "M√µtle, kas m√µne olulise v√§ite kohta on t√µend puudu.",
      "Koonda failid √ºhtsesse loogilisse struktuuri (nt kaustad v√µi failinimed).",
    ],
  },

  defenses: {
    title: "Vastuv√§ited",
    items: [
      "M√µtle, millistele v√§idetele teine pool v√µiks vastu vaielda.",
      "Pane kirja 2‚Äì3 k√µige t√µen√§olisemat vastuv√§idet.",
      "Kirjuta iga vastuv√§ite juurde l√ºhike vastus (fakt + olemasolev t√µend).",
      "M√§rgi, milline vastuv√§ide tundub Sulle k√µige n√µrgem koht.",
    ],
  },

  limitation: {
    title: "Aegumine",
    items: [
      "Pane kirja olulised kuup√§evad: millal kokkulepe s√µlmiti, millal rikkumine toimus, millal kahju ilmnes, millal teist poolt teavitati (kui teavitati).",
      "M√µtle, millal n√µue muutus tegelikult sissen√µutavaks (st hetk, mil teisel poolel oleks tulnud kohustus t√§ita).",
      "Kontrolli, kas vahepeal toimus midagi, mis v√µis aega m√µjutada (nt kirjavahetus, osaline tasumine, l√§bir√§√§kimised).",
      "M√µtle, kas Sinu juhtum v√µib kuuluda valdkonda, kus t√§htajad on tavap√§rasest erinevad (nt t√∂√∂-, √º√ºri- v√µi tarbijavaidlus).",
      "Kui Sa ei ole kindel, on m√µistlik seda k√§sitleda riskina ja arvestada sellega edasiste sammude planeerimisel.",
    ],
  },
};

  function renderActionPlan(scores){
    // Clear
    planBlocks.innerHTML = "";
    planConditionsList.innerHTML = "";

    // Conditions
    const conds = decisionConditionsFromScores(scores);
    if (conds.length === 0){
      const li = document.createElement("li");
      li.textContent = "Kriitilisi tingimusi ei tuvastatud. Vajadusel t√§psusta √ºksikuid detaile enne edasist sammu.";
      planConditionsList.appendChild(li);
    } else {
      for (const c of conds){
        const li = document.createElement("li");
        li.textContent = c;
        planConditionsList.appendChild(li);
      }
    }

    // Blocks: only for <= 1
    const order = ["basis","breach","damage","evidence","defenses","limitation"];
    for (const key of order){
      if (scores[key] > 1) continue;

      const block = document.createElement("div");
      block.className = "qblock";
      block.style.marginTop = "12px";

      const h = document.createElement("h3");
      h.className = "qtitle";
      h.textContent = TASKS[key].title;

      const ul = document.createElement("ul");
      ul.className = "list";
      ul.style.margin = "8px 0 0 18px";

      for (const item of TASKS[key].items){
        const li = document.createElement("li");
        li.textContent = item;
        ul.appendChild(li);
      }

      block.appendChild(h);
      block.appendChild(ul);
      
        // Lisa viivisekalkulaatori link ainult "Kahju" plokki
  if (key === "damage") {
    const p = document.createElement("p");
    p.className = "muted small";
    p.style.marginTop = "8px";
    p.innerHTML = `
      Vajadusel saad viivise ja intressi arvutada
      <a href="https://viivisekalkulaator.ee/calculator/debt"
         target="_blank" rel="noopener">
        viivisekalkulaator.ee lehel
      </a>.
    `;
    block.appendChild(p);
  }
      
      planBlocks.appendChild(block);
    }
  }

  function openPlan(){
    const saved = getSaved();
    if (!saved) return;

    // scores are saved as numbers 0-3 already
    const scores = {};
    for (const f of FIELDS){
      scores[f] = Number(saved[f]);
    }

    renderActionPlan(scores);
    actionPlanCard.hidden = false;
    actionPlanCard.scrollIntoView({ behavior: "smooth", block: "start" });
  }

  function closePlan(){
    actionPlanCard.hidden = true;
  }

  btnPlanOpen?.addEventListener("click", openPlan);
  btnPlanClose?.addEventListener("click", closePlan);
})();
</script>


</body>
</html>
